//@version=5
// ==============================================================================
// ðŸš€ PROJECT: APEX MOMENTUM [PRO SCALPER EDITION] - v29
// ==============================================================================
// 
// ðŸŽ¯ OBJECTIVE:
//    - We are NO LONGER trying to catch "Home Runs" (20% moves).
//    - We are hunting "Base Hits" (2.5% Gains).
//    - Why? A 50% Win Rate on small gains is better for mental health 
//      than a 20% Win Rate waiting for a miracle.
//
// âš™ï¸ THE 3 RISK PROFILES (MODES):
//    1. BALANCED (Default): The Sweet Spot.
//       - Take Profit: 2.5% | Stop Loss: 2.0%
//       - Best For: NVDA, AAPL, MSFT (Standard Tech).
//
//    2. WIDE SCALP (Volatile): Room to Breathe.
//       - Take Profit: 3.5% | Stop Loss: 3.0%
//       - Best For: Choppy days or erratic stocks.
//
//    3. SNIPER (Fast): Get In, Get Out.
//       - Take Profit: 1.5% | Stop Loss: 1.5%
//       - Best For: Crypto or Crash Protection.
//
// ðŸ§  THE GOLDEN RULES:
//    1. TRUST EXPECTANCY: If Expectancy is GREEN (>0.50%), the bot is printing money.
//    2. NO FOMO: If you sell at +2.5% and the stock goes up another 10%...
//       DO NOT REGRET IT. You chose safety over greed.
//    3. RED CLOUD = NO BUYS: Even if the setup looks perfect, we never fight the trend.
//
// ==============================================================================

indicator("Apex Momentum [PRO AI DASHBOARD]", overlay=true, shorttitle="Apex Pro", max_labels_count=500)

// ==========================================
// 1. VISUALS & DASHBOARD
// ==========================================
grp_vis   = "1. Visuals"
show_dash = input.bool(true, "Show Dashboard?", group=grp_vis)
theme_col = input.color(color.blue, "Theme Color", group=grp_vis)

// ==========================================
// 2. STRATEGY MODES (SCALPER TUNED)
// ==========================================
grp_mode  = "2. Risk Profile"
strategy_mode = input.string("Balanced Scalp (Default)", "Select Risk Profile", 
     options=["Balanced Scalp (Default)", "Wide Scalp (Volatile)", "Sniper Scalp (Fast)"], 
     group=grp_mode, tooltip="Balanced: 2.5% Target / 2% Stop.\nWide: 3% Target / 3% Stop.\nSniper: 1.5% Target / 1.5% Stop.")

// MANUAL OVERRIDE
use_manual = input.bool(false, "ðŸ”´ Enable Manual Settings?", group=grp_mode)
man_tp    = input.float(2.0, "Manual Take Profit %", step=0.1, group=grp_mode) / 100
man_sl    = input.float(2.0, "Manual Stop Loss %", step=0.1, group=grp_mode) / 100
man_trail = input.float(1.5, "Manual Trailing Stop %", step=0.1, group=grp_mode) / 100
man_buy   = input.int(20, "Manual Buy Trigger", group=grp_mode)

// ==========================================
// 3. LOGIC ENGINE (UPDATED DEFAULTS)
// ==========================================

// Mapping Modes to Math (TIGHTER STOPS / LOWER TARGETS)
var float auto_tp = 0.025
var float auto_sl = 0.02
var float auto_trail = 0.015
var int auto_buy = 60

if strategy_mode == "Balanced Scalp (Default)"
    auto_tp    := 0.025  // Aim for 2.5%
    auto_sl    := 0.020  // Risk 2.0%
    auto_trail := 0.015  // Lock in fast
    auto_buy   := 60
else if strategy_mode == "Wide Scalp (Volatile)"
    auto_tp    := 0.035
    auto_sl    := 0.030
    auto_trail := 0.025
    auto_buy   := 60
else if strategy_mode == "Sniper Scalp (Fast)"
    auto_tp    := 0.015  // Quick 1.5% snipe
    auto_sl    := 0.015
    auto_trail := 0.010
    auto_buy   := 20

// Apply Selection
final_tp    = use_manual ? man_tp : auto_tp
final_sl    = use_manual ? man_sl : auto_sl
final_trail = use_manual ? man_trail : auto_trail
final_buy   = use_manual ? man_buy : auto_buy

// Indicator Settings
grp_eng   = "3. Engine Settings"
ema_len   = input.int(50, "Trend Cloud Length", group=grp_eng)
stoch_len = input.int(14, "Momentum Length", group=grp_eng)
// Note: TP is now handled dynamically above based on mode

// Calculations
ema_cloud = ta.ema(close, ema_len)
trend_up  = close > ema_cloud
rsi1 = ta.rsi(close, stoch_len)
k = ta.sma(ta.stoch(rsi1, rsi1, rsi1, stoch_len), 3)
d = ta.sma(k, 3)

// SIGNALS
buy_signal = trend_up and ta.crossover(k, d) and k < final_buy

// ==========================================
// 4. TRADE SIMULATOR (STRICT ACCOUNTING)
// ==========================================
// State Variables
var bool in_trade = false
var float entry_price = 0.0
var float active_stop_level = 0.0 

// Stats Accumulators
var int cnt_wins = 0
var int cnt_loss = 0
var float sum_win_pct = 0.0
var float sum_loss_pct = 0.0

plot_buy  = false
plot_win  = false 
plot_loss = false

// --- EXECUTION LOGIC ---
if in_trade
    // Check Hard Stop Loss (Fixed %)
    if low <= active_stop_level
        in_trade := false
        cnt_loss += 1
        float loss_p = (entry_price - active_stop_level) / entry_price * 100
        sum_loss_pct += loss_p 
        plot_loss := true
    
    // Check Take Profit (Dynamic Target based on Mode)
    else if high >= entry_price * (1 + final_tp)
        in_trade := false
        cnt_wins += 1
        sum_win_pct += final_tp * 100
        plot_win := true
    
    // Update Trailing Stop
    else
        float new_trail = high * (1 - final_trail)
        if new_trail > active_stop_level
            active_stop_level := new_trail

// Check Entries
if buy_signal and not in_trade
    in_trade := true
    entry_price := close
    active_stop_level := close * (1 - final_sl)
    plot_buy := true

// --- STATISTICS ---
total_trades = cnt_wins + cnt_loss
win_rate = total_trades > 0 ? (cnt_wins / total_trades) * 100 : 0
avg_win  = cnt_wins > 0 ? sum_win_pct / cnt_wins : 0
avg_loss = cnt_loss > 0 ? sum_loss_pct / cnt_loss : 0
expectancy = ( (win_rate/100) * avg_win ) - ( ((100-win_rate)/100) * avg_loss )

// ==========================================
// 5. ATR VOLATILITY HINT
// ==========================================
atr_val = ta.atr(14)
atr_avg = ta.sma(atr_val, 20)
is_volatile = atr_val > (atr_avg * 1.1)

rec_text = is_volatile ? "SNIPER" : "BALANCED"
rec_color = is_volatile ? color.orange : color.aqua

// ==========================================
// 6. VISUALS
// ==========================================
cloud_color = close > ema_cloud ? color.green : color.red
plot(ema_cloud, color=cloud_color, linewidth=3, title="Trend Cloud")

if plot_buy
    label.new(bar_index, low, text="BUY\n" + str.tostring(close, format.mintick), color=color.green, style=label.style_label_up, textcolor=color.white, size=size.small)
if plot_win
    label.new(bar_index, high, text="WIN\n" + str.tostring(close, format.mintick), color=theme_col, style=label.style_label_down, textcolor=color.white, size=size.small)
if plot_loss
    label.new(bar_index, high, text="SELL\n" + str.tostring(close, format.mintick), color=color.red, style=label.style_label_down, textcolor=color.white, size=size.small)

// DASHBOARD
var table dash = table.new(position.top_right, 2, 8, bgcolor=color.new(color.black, 10), border_width=1)
if show_dash and barstate.islast
    table.cell(dash, 0, 0, "APEX SCALP", text_color=color.white, bgcolor=theme_col, text_size=size.normal)
    table.cell(dash, 1, 0, "v29", text_color=color.green, bgcolor=theme_col, text_size=size.normal)
    
    table.cell(dash, 0, 1, "Mode:", text_color=color.white, text_size=size.normal)
    style_name = "BALANCED"
    if use_manual
        style_name := "MANUAL"
    else if strategy_mode == "Wide Scalp (Volatile)"
        style_name := "SWING"
    else if strategy_mode == "Sniper Scalp (Fast)"
        style_name := "SNIPER"
    table.cell(dash, 1, 1, style_name, text_color=color.yellow, text_size=size.normal)
    
    table.cell(dash, 0, 2, "Vol. Hint:", text_color=color.silver, text_size=size.normal)
    table.cell(dash, 1, 2, rec_text, text_color=rec_color, text_size=size.normal)
    
    table.cell(dash, 0, 3, "Win Rate:", text_color=color.white, text_size=size.normal)
    table.cell(dash, 1, 3, str.tostring(win_rate, "#.#") + "%", text_color=win_rate > 50 ? color.green : color.red, text_size=size.normal)
    
    table.cell(dash, 0, 4, "Trades:", text_color=color.white, text_size=size.normal)
    table.cell(dash, 1, 4, str.tostring(total_trades), text_color=color.white, text_size=size.normal)

    table.cell(dash, 0, 5, "Avg Win:", text_color=color.silver, text_size=size.normal)
    table.cell(dash, 1, 5, "+" + str.tostring(avg_win, "#.##") + "%", text_color=color.green, text_size=size.normal)

    table.cell(dash, 0, 6, "Avg Loss:", text_color=color.silver, text_size=size.normal)
    table.cell(dash, 1, 6, "-" + str.tostring(avg_loss, "#.##") + "%", text_color=color.red, text_size=size.normal)

    table.cell(dash, 0, 7, "Expectancy:", text_color=color.white, text_size=size.normal)
    exp_col = expectancy > 0 ? color.lime : color.red
    table.cell(dash, 1, 7, str.tostring(expectancy, "#.##") + "%", text_color=exp_col, text_size=size.normal)