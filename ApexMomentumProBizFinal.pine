//@version=5
// ==============================================================================
// ðŸš€ APEX MOMENTUM [PRO BIZ EDITION] - v35 (GOLD MASTER) - Perfect strategy, working fine 
// ==============================================================================
// 
// FINAL CHANGE LOG:
// 1. VOL DELTA LABEL: Increased size to "Normal" to mimic Bold visibility.
// 2. LOGIC LOCKED: Cooldowns, Fees, and Net Profit math are finalized.
//
// ==============================================================================

indicator("Apex Momentum [PRO BIZ DASHBOARD]", overlay=true, shorttitle="Apex Pro", max_labels_count=500)

// ==========================================
// 1. BUSINESS SETTINGS
// ==========================================
grp_biz   = "1. Business Logic"
comm_val  = input.float(0.35, "Commission per Trade ($)", minval=0.0, step=0.01, group=grp_biz, tooltip="Your specific broker fee per trade.")
order_amt = input.float(1000, "Order Size ($)", minval=100, step=100, group=grp_biz, tooltip="Capital allocated per trade.")

// ==========================================
// 2. RISK PROFILES
// ==========================================
grp_mode  = "2. Risk Profile"
strategy_mode = input.string("Wide Scalp (Volatile)", "Select Risk Profile", 
     options=["Wide Scalp (Volatile)", "Balanced Scalp (Default)", "Sniper Scalp (Fast)"], 
     group=grp_mode, tooltip="Adjusts Stop Loss and Take Profit width.")

// MANUAL OVERRIDE
use_manual = input.bool(false, "Override Default Settings?", group=grp_mode, tooltip="Check this box to use the custom numbers below.")
man_tp    = input.float(3.5, "Manual Take Profit %", step=0.1, group=grp_mode) / 100
man_sl    = input.float(3.0, "Manual Stop Loss %", step=0.1, group=grp_mode) / 100
man_trail = input.float(2.5, "Manual Trailing Stop %", step=0.1, group=grp_mode) / 100
man_buy   = input.int(60, "Manual Buy Trigger", group=grp_mode)

// ==========================================
// 3. LOGIC ENGINE
// ==========================================
var float auto_tp = 0.035
var float auto_sl = 0.030
var float auto_trail = 0.025
var int auto_buy = 60

if strategy_mode == "Balanced Scalp (Default)"
    auto_tp    := 0.025
    auto_sl    := 0.020
    auto_trail := 0.015
    auto_buy   := 60
else if strategy_mode == "Wide Scalp (Volatile)"
    auto_tp    := 0.035
    auto_sl    := 0.030
    auto_trail := 0.025
    auto_buy   := 60
else if strategy_mode == "Sniper Scalp (Fast)"
    auto_tp    := 0.015
    auto_sl    := 0.015
    auto_trail := 0.010
    auto_buy   := 20

// Logic: If 'use_manual' is TRUE, use 'man_tp'. Else, use 'auto_tp'.
final_tp    = use_manual ? man_tp : auto_tp
final_sl    = use_manual ? man_sl : auto_sl
final_trail = use_manual ? man_trail : auto_trail
final_buy   = use_manual ? man_buy : auto_buy

// Engine
grp_vis   = "3. Visuals"
show_dash = input.bool(true, "Show Dashboard?", group=grp_vis)
theme_col = input.color(color.blue, "Theme Color", group=grp_vis)
ema_len   = 50
stoch_len = 14

// Calculations
ema_cloud = ta.ema(close, ema_len)
trend_up  = close > ema_cloud
rsi1 = ta.rsi(close, stoch_len)
k = ta.sma(ta.stoch(rsi1, rsi1, rsi1, stoch_len), 3)
d = ta.sma(k, 3)

// Signals
buy_signal = trend_up and ta.crossover(k, d) and k < final_buy

// ==========================================
// 4. TRADE SIMULATOR
// ==========================================
var bool in_trade = false
var float entry_price = 0.0
var float active_stop_level = 0.0 
var int cnt_wins = 0
var int cnt_loss = 0
var float sum_win_pct = 0.0
var float sum_loss_pct = 0.0
var int last_exit_bar = 0 // Tracks when we last sold to prevent re-entry same bar

plot_buy  = false
plot_win  = false 
plot_loss = false

if in_trade
    // EXIT 1: STOP LOSS
    if low <= active_stop_level
        in_trade := false
        cnt_loss += 1
        float loss_p = (entry_price - active_stop_level) / entry_price * 100
        sum_loss_pct += loss_p 
        plot_loss := true
        last_exit_bar := bar_index
    // EXIT 2: TAKE PROFIT
    else if high >= entry_price * (1 + final_tp)
        in_trade := false
        cnt_wins += 1
        sum_win_pct += final_tp * 100
        plot_win := true
        last_exit_bar := bar_index
    // TRAILING STOP UPDATE
    else
        float new_trail = high * (1 - final_trail)
        if new_trail > active_stop_level
            active_stop_level := new_trail

// ENTRY CONDITION
// Checks: Signal valid? Not in trade? AND did we NOT just exit on this same bar?
if buy_signal and not in_trade and bar_index != last_exit_bar
    in_trade := true
    entry_price := close
    active_stop_level := close * (1 - final_sl)
    plot_buy := true

// Stats
total_trades = cnt_wins + cnt_loss
win_rate = total_trades > 0 ? (cnt_wins / total_trades) * 100 : 0
avg_win_pct  = cnt_wins > 0 ? sum_win_pct / cnt_wins : 0
avg_loss_pct = cnt_loss > 0 ? sum_loss_pct / cnt_loss : 0
gross_expectancy_pct = ( (win_rate/100) * avg_win_pct ) - ( ((100-win_rate)/100) * avg_loss_pct )

// Net Profit Calc
gross_profit_dollar = order_amt * (gross_expectancy_pct / 100)
net_profit_dollar = gross_profit_dollar - comm_val

// Total Estimated Profit
total_estimated_profit = total_trades * net_profit_dollar

// ==========================================
// 5. VISUALS & VOLUME MONITOR
// ==========================================
cloud_color = close > ema_cloud ? color.green : color.red
plot(ema_cloud, color=cloud_color, linewidth=3, title="Trend Cloud")

if plot_buy
    label.new(bar_index, low, text="BUY\n" + str.tostring(close, format.mintick), color=color.green, style=label.style_label_up, textcolor=color.white, size=size.small)
if plot_win
    label.new(bar_index, high, text="WIN\n" + str.tostring(close, format.mintick), color=theme_col, style=label.style_label_down, textcolor=color.white, size=size.small)
if plot_loss
    label.new(bar_index, high, text="SELL\n" + str.tostring(close, format.mintick), color=color.red, style=label.style_label_down, textcolor=color.white, size=size.small)

// LIVE VOLUME DELTA (Updated for Visibility)
var label vol_lbl = label.new(na, na, "", style=label.style_label_left, color=color.new(color.black, 50), textcolor=color.white, size=size.normal)

if barstate.islast
    float range_size = high - low
    // Estimate Volume Split
    float buy_ratio = range_size > 0 ? (close - low) / range_size : 0.5
    float buy_vol = volume * buy_ratio
    float sell_vol = volume * (1 - buy_ratio)
    float delta_vol = buy_vol - sell_vol
    
    // Set Color
    color d_col = delta_vol > 0 ? color.lime : color.red
    string d_sym = delta_vol > 0 ? "+" : ""
    
    // Update Label (Moves with the candle)
    label.set_xy(vol_lbl, bar_index + 3, close)
    label.set_text(vol_lbl, "VOL DELTA\nBuy: " + str.tostring(buy_vol, format.volume) + "\nSell: " + str.tostring(sell_vol, format.volume) + "\nÎ”: " + d_sym + str.tostring(delta_vol, format.volume))
    label.set_color(vol_lbl, color.new(d_col, 80))
    label.set_textcolor(vol_lbl, d_col)

// DASHBOARD
var table dash = table.new(position.top_right, 2, 10, bgcolor=color.new(color.black, 10), border_width=1)
if show_dash and barstate.islast
    table.cell(dash, 0, 0, "APEX BIZ", text_color=color.white, bgcolor=theme_col, text_size=size.normal)
    table.cell(dash, 1, 0, "PRO v35", text_color=color.green, bgcolor=theme_col, text_size=size.normal)
    
    table.cell(dash, 0, 1, "Capital:", text_color=color.silver, text_size=size.normal)
    table.cell(dash, 1, 1, "$" + str.tostring(order_amt), text_color=color.white, text_size=size.normal)
    
    table.cell(dash, 0, 2, "Fee/Trade:", text_color=color.silver, text_size=size.normal)
    table.cell(dash, 1, 2, "$" + str.tostring(comm_val), text_color=color.red, text_size=size.normal)
    
    table.cell(dash, 0, 3, "Trades:", text_color=color.white, text_size=size.normal)
    table.cell(dash, 1, 3, str.tostring(total_trades), text_color=color.white, text_size=size.normal)

    table.cell(dash, 0, 4, "Win Rate:", text_color=color.white, text_size=size.normal)
    table.cell(dash, 1, 4, str.tostring(win_rate, "#.#") + "%", text_color=win_rate > 30 ? color.green : color.orange, text_size=size.normal)
    
    table.cell(dash, 0, 5, "---", text_color=color.gray, text_size=size.small)
    table.cell(dash, 1, 5, "---", text_color=color.gray, text_size=size.small)

    table.cell(dash, 0, 6, "Net PnL/$:", text_color=color.white, text_size=size.normal)
    pnl_col = net_profit_dollar > 0 ? color.lime : color.red
    table.cell(dash, 1, 6, "$" + str.tostring(net_profit_dollar, "#.##"), text_color=pnl_col, text_size=size.large)

    // ROW 7: TOTAL PROFIT
    table.cell(dash, 0, 7, "Tot Profit:", text_color=color.white, text_size=size.normal)
    tot_col = total_estimated_profit > 0 ? color.lime : color.red
    string tot_sign = total_estimated_profit > 0 ? "+" : ""
    table.cell(dash, 1, 7, tot_sign + "$" + str.tostring(total_estimated_profit, "#.00"), text_color=tot_col, text_size=size.normal)

    status_txt = net_profit_dollar > 0 ? "VIABLE" : "LOW CAP"
    status_col = net_profit_dollar > 0 ? color.green : color.red
    table.cell(dash, 0, 8, "Status:", text_color=color.white, text_size=size.normal)
    table.cell(dash, 1, 8, status_txt, text_color=status_col, text_size=size.normal)

alertcondition(plot_buy, title="Apex BUY", message="Apex BUY: {{ticker}} @ {{close}}")
alertcondition(plot_win, title="Apex WIN", message="Apex WIN: {{ticker}} @ {{close}}")
alertcondition(plot_loss, title="Apex SELL", message="Apex SELL: {{ticker}} @ {{close}}")