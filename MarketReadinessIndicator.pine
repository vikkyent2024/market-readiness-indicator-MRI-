//@version=5
indicator("Market Readiness Indicator [MRI]", shorttitle="MRI", overlay=true)

// ==========================================
// 1. INPUTS
// ==========================================
show_bg = input.bool(true, "Show Background Tint")

// ==========================================
// 2. HELPER FUNCTIONS
// ==========================================
// Standard Normalize
normalize(val, min, max) =>
    (math.max(min, math.min(val, max)) - min) / (max - min) * 100

// ==========================================
// 3. MARKET DIMENSIONS
// ==========================================

// --- A. Direction (Bias) ---
// EMA 50 Baseline + Slope
baseline_len = 50
baseline = ta.ema(close, baseline_len)
// Slope over 5 bars for faster reaction than 10
slope = (baseline - baseline[5]) / baseline[5]
// Price relative to baseline
bias_bullish = close > baseline and slope > 0
bias_bearish = close < baseline and slope < 0

// --- B. Quality (Efficiency) ---
// Kaufman Efficiency Ratio (ER)
len_er = 14 // Standard shorter length for reaction
change = math.abs(close - close[len_er])
vol_sum = math.sum(math.abs(close - close[1]), len_er)
er = vol_sum != 0 ? change / vol_sum : 0
// Quality Thresholds
// > 0.30 = Trending/High Quality
// < 0.15 = Chop/No Edge
is_chop = er < 0.15
is_quality = er >= 0.30
// "Okay" quality is between 0.15 and 0.30

// --- C. Extension (Exhaustion) ---
// Bollinger Band Width limit
// If price > 2.2 SD, it's extended
sd = ta.stdev(close, 50)
upper_dev = baseline + (2.2 * sd)
lower_dev = baseline - (2.2 * sd)
is_extended_long = close > upper_dev
is_extended_short = close < lower_dev

// --- D. Volatility Risk (Avoid) ---
// Detect extreme volatility spikes (Flash crash / Pump)
atr = ta.atr(14)
atr_avg = ta.sma(atr, 50)
// If ATR is 2.5x the average, it's high risk
is_vol_spike = atr > (atr_avg * 2.5)

// ==========================================
// 4. DECISION ENGINE (5 STATES)
// ==========================================
// States:
// 2  = LONG - Trend Active
// -2 = SHORT - Trend Active
// 1  = WAIT - Pullback / Reset
// 0  = NO EDGE - Chop
// -9 = AVOID - High Risk

int state = 0 

// Priority Logic (Safety First)

if is_vol_spike
    state := -9 // AVOID
else
    // Bias Logic First
    if bias_bullish
        if is_quality and not is_extended_long
            state := 2 // LONG (Good Quality + Not Extended)
        else
            state := 1 // WAIT (Extended OR Low Quality, but Bias holds)
    else if bias_bearish
        if is_quality and not is_extended_short
            state := -2 // SHORT (Good Quality + Not Extended)
        else
            state := 1 // WAIT (Extended OR Low Quality, but Bias holds)
    else
        // Bias is strictly neutral (Flat or conflicting)
        state := 0 // NO EDGE

// ==========================================
// 5. TRANSITION RULES (HOLDING LOGIC)
// ==========================================
// Rule: Do NOT flip directly from LONG -> SHORT or SHORT -> LONG
var int prev_major_state = 0 // Track last active trend (2 or -2)

// If trying to flip trend directly
if (state == 2 and prev_major_state == -2) or (state == -2 and prev_major_state == 2)
    state := 0 // Force NO EDGE transit

// Graceful Degradation Logic
// If we drop from a trend to NO EDGE directly, force WAIT instead
if state == 0
    if state[1] == 2 or state[1] == -2
        state := 1

// Update history
if state == 2 or state == -2
    prev_major_state := state

// ==========================================
// 6. VISUALIZATION
// ==========================================

// Colors
c_long  = color.new(#4caf50, 0) // Green
c_short = color.new(#ef5350, 0) // Red
c_wait  = color.new(#ff9800, 0) // Orange
c_chop  = color.new(#9e9e9e, 0) // Grey
c_avoid = color.new(#7e57c2, 0) // Purple/Dark

c_bg_long  = color.new(#4caf50, 92)
c_bg_short = color.new(#ef5350, 92)
c_bg_wait  = color.new(#ff9800, 92)
c_bg_chop  = color.new(#9e9e9e, 94)
c_bg_avoid = color.new(#7e57c2, 90)

// Text & Color Mapping
var string txt = "NO EDGE - Chop"
var color col = c_chop
var color bgc = c_bg_chop

if state == 2
    txt := "LONG – Trend Active"
    col := c_long
    bgc := c_bg_long
else if state == -2
    txt := "SHORT – Trend Active"
    col := c_short
    bgc := c_bg_short
else if state == 1
    txt := "WAIT – Pullback / Reset"
    col := c_wait
    bgc := c_bg_wait
else if state == -9
    txt := "AVOID – High Risk"
    col := c_avoid
    bgc := c_bg_avoid
else
    txt := "NO EDGE – Chop"
    col := c_chop
    bgc := c_bg_chop

// Background
bgcolor(show_bg ? bgc : na, title="State Background")

// Table Panel
var table panel = table.new(position.top_right, 1, 2, border_width=0)

if barstate.islast
    // Statistic Subtext
    // Row 0: State
    table.cell(panel, 0, 0, txt, bgcolor=col, text_color=color.white, text_size=size.small, width=16)
    // Row 1: Subtitle
    table.cell(panel, 0, 1, "This indicator defines when to trade, not how to enter.", bgcolor=color.new(color.white, 100), text_color=color.gray, text_size=size.tiny)

// ==========================================
// 7. ALERTS
// ==========================================
alertcondition(state != state[1], title="State Changed", message="MRI State changed to {{plot_0}}")
